# Progress Log

- 2025-10-28: Auth persistence — introduced an AuthProvider that restores Supabase sessions via AsyncStorage during the splash sequence, ensuring valid users land on the Dashboard automatically and invalid tokens drop back to Login.
- 2025-12-20: ELO system integration — added ELO rating to profiles, implemented `match-update` edge function for cooperative rating adjustments, and updated Explore screen to use hybrid scoring (PCA + ELO).
- 2025-12-25: NLP Hobby Matching — implemented `embed` edge function (deterministic mock for stability), updated `recommend-users` to support hobby vectors, and added `hobbies_cipher` for privacy. Added `ProfileDetailModal` for viewing matches. Reverted to Single Table Architecture (`profiles`) for stability.
- 2025-12-26: UI Polish & Messaging — Improved Chat UI with user-scoped caching, single-line session separators, and auto-scroll fixes. Enhanced `UserSettingsScreen` with avatar cropping (expo-image-manipulator) and "Verified" email badge. Fixed `PGRST200` and `PGRST204` errors by sanitizing upsert payloads. Stabilized Edge Functions with robust error handling and reverted to Single Table Architecture to resolve join issues.
- 2026-01-05: Matching & Profiles — Added RecommendationContext to centralize pools, new filters (age/gender/archetype/hobbies), and pagination responses in `recommend-users`. Boosted hobby weight; embed edge now uses Jina with dimensionality set. Fixed i18n gaps for filters. Added public profile modal reuse across Explore, Messages, and Notifications.
- 2026-01-06: Messaging polish — Realtime thread previews fixed via message insert subscription + focus refresh. Profile modals now fetch fallback from `profiles` when `profile_lookup` lacks encrypted hobbies and show decrypt errors when applicable. Notifications now mark as read on tap (not on screen focus); info buttons enlarged with i18n labels. Remaining issues: profile modal from Messages sometimes still missing public data/hobbies (investigate data availability in profile_lookup/profiles), and ensure decrypt succeeds consistently.
- 2025-12-27: Fixed Messages Profile Modal & Recommendations — Resolved issue where matched user profiles failed to load details due to RLS restrictions by adding `get_matched_profile` RPC. Fixed inconsistent recommendation results by correcting state closure issues in `loadMore` and `reset` within `RecommendationContext`.
- 2025-12-27: Notifications & Interactions Overhaul — Refactored `MatchesScreen` to use `ProfileDetailModal` exclusively, removing `UserInfoModal`. Notifications now only mark as read upon explicit user interaction (opening chat, or viewing profile details), resolving the "auto-read on list open" bug. Decoupled types and streamlined action handling for Likes/Skips directly from the profile modal.
- 2025-12-27: Explore & Settings Polishing — Fixed missing avatar image in Explore cards by adding `avatar_url` to `recommend-users` edge function. Implemented global profile state synchronization by exposing and calling `refreshProfile` in `AuthContext` when saving settings, ensuring hobby filters enable immediately after adding hobbies.
- 2025-12-27: Global State Enhancement (Zustand) — Implemented `notificationStore` and `messagesStore` to manage realtime state globally. Refactored `MatchesScreen`, `MessagesScreen`, and `AppNavigator` to use these stores, ensuring instant UI updates for badges, inbox threads, and notifications across screens. Optimized `ChatScreen` interactions to update the global inbox state optimistically.
- 2025-12-27: Match Logic & Notification Fixes — Fixed 'phantom match' issue where `match-update` incorrectly matched users based on stale 'like' events (now checks most recent event). Implemented missing logic to actually insert 'like' notifications in `match-update` edge function, ensuring users are notified when liked.
- 2025-12-27: Security & Data Access Hardening — Identified and fixed RLS bypass issues. Updated `messagesStore` and `MatchesScreen` to use `get_profile_lookup` RPC instead of the view (which returned nothing due to RLS). Enhanced `get_matched_profile` RPC to allow users to view profiles of pending likes, ensuring informed decision-making.
- 2025-12-27: Data Integrity Fix (Data Wipe) — Fixed a critical bug in `UserSettingsScreen` where updating a profile (e.g., adding hobbies) would overwrite existing fields (like PCA scores) with `null` if the local state wasn't fully hydrated. Refactored `buildProfilePayload` to use `undefined` instead of default `null` and strip undefined keys, preventing accidental data loss during upserts.
- 2025-12-27: Profile Access Refactor — Transitioned profile fetching in `MatchesScreen` and `MessagesScreen` to use a new, secure Edge Function `get-profile-details`. This replaces unreliable RPC/View logic and ensures consistent, authenticated access to full profile data (including encrypted hobbies) for matches and pending likes, bypassing RLS limitations effectively. Corrected `MessagesScreen` to also use this new function.
- 2025-12-27: App Stability & Data Freshness — Ensured `notificationStore` and `messagesStore` are correctly reset upon logout in `AppNavigator` to prevent data leaks between sessions. Updated `CreateAccountScreen` to force a profile refresh immediately after account creation, preventing subsequent profile updates (like adding hobbies) from overwriting fresh registration data (like PCA scores) due to stale local state.
- 2025-12-27: Settings Screen Sync — Fixed issue where profile settings fields (Username, Age, Gender) appeared empty after fresh registration/login. Added `useEffect` hook to synchronize local state with `AuthContext` profile updates and enhanced initial state to check `user_metadata` as a fallback.
- 2025-12-27: Match UX Improvement — Added immediate "It's a Match!" confirmation modal in `MatchesScreen` when a user likes back via a notification. This provides clear feedback and a direct path to chat, preventing confusion when the profile modal silently closed previously. Updated `messagesStore` real-time subscription logic to ensure new matches appear instantly in the inbox without refresh.
- 2025-12-27: Realtime Architecture Overhaul — Implemented centralized `RealtimeManager` singleton to handle all subscriptions (Messages, Notifications, Matches). This fixes the issue where new conversation threads wouldn't appear instantly upon matching (phantom match UI). Updated `messagesStore` and `notificationStore` to receive push updates from the manager, ensuring consistent and instant state synchronization across the app.
- 2025-12-27: Deprecation Fix — Migrated from `expo-av` to `expo-audio` to resolve SDK 54 deprecation warning. Refactored `RealtimeManager` to delegate sound playback to `AppNavigator` via callback, leveraging React hooks for audio management. Removed `expo-av` dependency.
- 2025-12-27: Realtime Reliability — Enabled `REPLICA IDENTITY FULL` on critical tables to ensure `INSERT` events carry full payloads. Added "Skeleton Thread" fallback in `RealtimeManager` to instantly show new matches even if profile fetching lags. Updated `notificationStore` and `messagesStore` to react to these external manager events.
- 2025-12-27: Notification Content Fix — Updated `notify` edge function to robustly fetch sender profile details server-side if missing from client payload. This fixes the issue where notifications displayed "Unknown user" or the recipient's own name instead of the sender's.
- 2025-12-27: Database Triggers for Consistency — Replaced manual client-side `notify` calls with robust Postgres Triggers.
    *   `on_new_message_notify`: Automatically inserts a notification when a message is inserted into `public.messages`.
    *   `on_new_match_notify`: Automatically inserts mutual notifications when a row is inserted into `public.matches`.
    *   This guarantees 100% notification reliability and prevents "missing notification" issues caused by client/network failures.
